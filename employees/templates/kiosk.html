<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Kiosko de Asistencia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root{
            --bg1:#0b1220;
            --bg2:#0f172a;
            --card: rgba(255,255,255,0.06);
            --card2: rgba(255,255,255,0.08);
            --text:#e5e7eb;
            --muted:#94a3b8;

            --ok:#00e676;
            --ok2:#00c853;
            --warn:#ffc107;
            --err:#ff5252;

            --border: rgba(255,255,255,0.12);
            --shadow: 0 18px 60px rgba(0,0,0,.45);
            --shadow2: 0 12px 30px rgba(0,0,0,.35);
            --ring: 0 0 0 4px rgba(37,99,235,.25);
        }

        *{ box-sizing:border-box; margin:0; padding:0; }
        body{
            min-height:100vh;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(1200px 700px at 20% 10%, rgba(37,99,235,.18), transparent 60%),
                        radial-gradient(900px 600px at 90% 15%, rgba(0,230,118,.14), transparent 55%),
                        linear-gradient(135deg, var(--bg1), var(--bg2));
            color: var(--text);
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 24px;
        }

        .kiosk-shell{
            width: 100%;
            max-width: 980px;
            display:flex;
            flex-direction: column;
            align-items:center;
            gap: 18px;
        }

        .topbar{
            width:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            gap: 10px;
            padding: 14px 16px;
            border-radius: 16px;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow2);
            backdrop-filter: blur(10px);
        }

        .brand-dot{
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--ok);
            box-shadow: 0 0 0 6px rgba(0,230,118,.12);
        }

        h2{
            font-size: clamp(20px, 2.6vw, 28px);
            letter-spacing: .3px;
            font-weight: 800;
            margin: 0;
        }

        .subtitle{
            width:100%;
            text-align:center;
            color: var(--muted);
            font-size: 14px;
            margin-top: -6px;
        }

        .main-card{
            width: 100%;
            border-radius: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 18px;
            backdrop-filter: blur(10px);
        }

        .video-wrap{
            width: 100%;
            display:flex;
            justify-content:center;
            align-items:center;
        }

        video{
            width: 100%;
            max-width: 720px;
            aspect-ratio: 4/3;
            border-radius: 18px;
            border: 3px solid rgba(0,230,118,.85);
            box-shadow: 0 0 0 6px rgba(0,230,118,.12), 0 18px 45px rgba(0,0,0,.45);
            background: rgba(0,0,0,.35);
            object-fit: cover;
        }

        #result{
            margin-top: 16px;
            text-align:center;
            font-size: clamp(16px, 2.1vw, 22px);
            line-height: 1.35;
            color: #ffffff;
            padding: 14px 16px;
            border-radius: 14px;
            background: rgba(0,0,0,.25);
            border: 1px solid rgba(255,255,255,.08);
            backdrop-filter: blur(8px);
            min-height: 56px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap: 10px;
        }

        /* peque√±a ‚Äúp√≠ldora‚Äù de estado (no afecta nada del JS) */
        .status-pill{
            display:inline-flex;
            align-items:center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted);
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.08);
            margin: 12px auto 0;
        }

        .pulse{
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--ok);
            box-shadow: 0 0 0 0 rgba(0,230,118,.55);
            animation: pulse 1.6s infinite;
        }

        @keyframes pulse{
            0%{ box-shadow: 0 0 0 0 rgba(0,230,118,.45); }
            70%{ box-shadow: 0 0 0 10px rgba(0,230,118,0); }
            100%{ box-shadow: 0 0 0 0 rgba(0,230,118,0); }
        }

        /* Caja de confirmaci√≥n m√°s pro (sin tocar IDs existentes) */
        #confirmBox{
            margin-top: 14px;
            margin: 0 auto;
            display:none;
            width: 100%;
            max-width: 720px;
            border-radius: 16px;
            background: rgba(255,255,255,.07);
            border: 1px solid rgba(255,255,255,.12);
            box-shadow: var(--shadow2);
            padding: 16px;
            text-align:center;
            backdrop-filter: blur(10px);
        }

        #confirmName{
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 6px;
            color: #ffffff;
        }

        #confirmType{
            font-weight: 900;
            letter-spacing: .8px;
        }

        .confirm-row{
            margin-top: 12px;
            display:flex;
            gap: 10px;
            justify-content:center;
            flex-wrap: wrap;
        }

        button{
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.08);
            color: #ffffff;
            transition: transform .08s ease, background .2s ease, border-color .2s ease;
            min-width: 150px;
            user-select:none;
        }

        button:hover{
            background: rgba(255,255,255,.12);
            border-color: rgba(255,255,255,.22);
        }

        button:active{
            transform: scale(0.98);
        }

        #btnConfirm{
            background: rgba(0,230,118,.14);
            border-color: rgba(0,230,118,.35);
        }
        #btnConfirm:hover{
            background: rgba(0,230,118,.22);
            border-color: rgba(0,230,118,.55);
        }

        #btnCancel{
            background: rgba(255,82,82,.12);
            border-color: rgba(255,82,82,.32);
        }
        #btnCancel:hover{
            background: rgba(255,82,82,.18);
            border-color: rgba(255,82,82,.52);
        }

        /* Responsive: en tablets queda muy bien */
        @media (max-width: 820px){
            .main-card{ padding: 14px; }
            video{ max-width: 100%; }
            #confirmBox{ max-width: 100%; }
            button{ min-width: 140px; }
        }

        @media (max-width: 480px){
            .topbar{ border-radius: 14px; }
            .main-card{ border-radius: 16px; }
            video{ border-radius: 16px; }
            #result{ border-radius: 12px; padding: 12px; }
            button{ width: 100%; }
        }
    </style>
</head>

<body>

    <div class="kiosk-shell">
        <div class="topbar">
            <span class="brand-dot"></span>
            <h2>Kiosko de Registro</h2>
        </div>

        <div class="subtitle">Ubica tu rostro al centro para registrar tu asistencia</div>

        <div class="main-card">
            <div class="video-wrap">
                <video id="video" autoplay></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <div class="status-pill">
                <span class="pulse"></span>
                <span>Escaneando autom√°ticamente</span>
            </div>

            <div id="result">Esperando rostro...</div>

            <!-- üîπ NUEVO: Caja de confirmaci√≥n -->
            <div id="confirmBox" style="display:none;">
                <div style="font-weight:bold;" id="confirmName"></div>
                <div style="margin:6px 0;">
                    ¬øConfirmar <span id="confirmType"></span>?
                </div>

                <div class="confirm-row">
                    <button id="btnConfirm">Confirmar</button>
                    <button id="btnCancel" style="margin-left:8px;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const resultDiv = document.getElementById('result');
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// üîπ Control de estado
let pendingId = null;
let scanningPaused = false;
let cameraReady = false;

// Abrir c√°mara
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
    video.srcObject = stream;
    video.play();

    video.onloadedmetadata = () => {
        cameraReady = true;
        console.log("üì∑ C√°mara lista:", video.videoWidth, video.videoHeight);
    };
})
.catch(err => {
    console.error(err);
    resultDiv.innerText = "No se pudo abrir la c√°mara";
});

// Capturar frame cada 2 segundos
setInterval(() => {
    captureAndSend();
}, 2000);

function captureAndSend() {
    if (scanningPaused) return;
    if (!cameraReady) return;
    if (!video.videoWidth || !video.videoHeight) return;

    const context = canvas.getContext('2d');

    // üî• CLAVE: usar tama√±o REAL del video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
        if (!blob) {
            console.warn("‚ùå Blob vac√≠o");
            return;
        }

        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');

        fetch('/employees/recognize-face/', {
    method: 'POST',
    body: formData
})
.then(async res => {
    const data = await res.json();
    return { ok: res.ok, data };
})
.then(({ ok, data }) => {
    console.log("RESPUESTA BACKEND:", data);

    // üîπ Error controlado (ej: rostro sin calidad suficiente)
    if (!ok && data.error) {
        resultDiv.innerHTML = "üì∑ Ajusta tu rostro al centro";
        resultDiv.style.color = "#ffffff";
        return;
    }

    // üîπ Error gen√©rico
    if (data.error) {
        resultDiv.innerHTML = "Buscando rostro...";
        resultDiv.style.color = "#ffffff";
        return;
    }

    if (data.recognized === true) {

        // üõë Caso bloqueado (ya marc√≥ todo hoy)
        if (data.blocked === true) {
            resultDiv.innerHTML =
                "‚ö†Ô∏è <b>" + data.employee_name + "</b><br>" +
                (data.message || "Asistencia ya completada");
            resultDiv.style.color = "#ffc107";

            setTimeout(() => {
                scanningPaused = false;
            }, 2000);

            return;
        }

        // Caso normal (requiere confirmaci√≥n)
        resultDiv.innerHTML = "‚úÖ Bienvenido <br><b>" + data.employee_name + "</b>";
        resultDiv.style.color = "#00e676";

        showConfirmBox(
            data.employee_name,
            data.suggested_type,
            data.pending_id
        );
        return;
    }

    // No reconocido
    resultDiv.innerHTML = "‚ùå " + (data.message || "Rostro no registrado");
    resultDiv.style.color = "#ff5252";
})
.catch(err => {
    console.error("ERROR FETCH:", err);
    resultDiv.innerText = "Error de conexi√≥n";
});


    }, 'image/jpeg', 0.9);
}

// ================================
// üîπ FUNCIONES DE CONFIRMACI√ìN
// ================================

function showConfirmBox(name, type, pid) {
    pendingId = pid;
    scanningPaused = true;

    document.getElementById("confirmName").textContent = name;
    document.getElementById("confirmType").textContent =
        type === "in" ? "ENTRADA" : "SALIDA";

    document.getElementById("confirmBox").style.display = "block";
}

function hideConfirmBox() {
    pendingId = null;
    document.getElementById("confirmBox").style.display = "none";
}

async function confirmAttendance() {
    if (!pendingId) return;

    const res = await fetch("/employees/confirm-attendance/", {
        method: "POST",
        headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
    },
        body: JSON.stringify({ pending_id: pendingId })
    });

    const data = await res.json();

    if (data.success) {
        let msg = "üïí <b>" + data.attendance_type.toUpperCase() + "</b>";

        if (data.status === "late") {
            msg += "<br>‚è∞ Atraso";
            if (data.delay_minutes !== null) {
                msg += " (" + data.delay_minutes + " min)";
            }
            resultDiv.style.color = "#ff9800";
        } else {
            msg += "<br>‚úÖ A tiempo";
            resultDiv.style.color = "#00c853";
        }

        resultDiv.innerHTML = msg;
    } else {
        resultDiv.innerHTML = "‚ùå Error al registrar asistencia";
        resultDiv.style.color = "#ff5252";
    }

    hideConfirmBox();

    setTimeout(() => {
        scanningPaused = false;
    }, 1200);
}

function cancelAttendance() {
    hideConfirmBox();
    scanningPaused = false;
}

document.getElementById("btnConfirm").addEventListener("click", confirmAttendance);
document.getElementById("btnCancel").addEventListener("click", cancelAttendance);
</script>

</body>
</html>