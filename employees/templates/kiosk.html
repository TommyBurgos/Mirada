<!DOCTYPE html>
<html>
<head>
    <title>Kiosko de Asistencia</title>
    <style>
        body {
            text-align: center;
            font-family: Arial;
            background: #111;
            color: white;
        }
        video {
            border: 4px solid #00c853;
            border-radius: 10px;
            width: 480px;
        }
        #result {
            margin-top: 20px;
            font-size: 22px;
        }
        #confirmBox {
            margin-top: 15px;
        }
        button {
            padding: 8px 14px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h2>Kiosko de Registro</h2>
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div id="result">Esperando rostro...</div>

    <!-- üîπ NUEVO: Caja de confirmaci√≥n -->
    <div id="confirmBox" style="display:none;">
        <div style="font-weight:bold;" id="confirmName"></div>
        <div style="margin:6px 0;">
            ¬øConfirmar <span id="confirmType"></span>?
        </div>

        <button id="btnConfirm">Confirmar</button>
        <button id="btnCancel" style="margin-left:8px;">Cancelar</button>
    </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const resultDiv = document.getElementById('result');

// üîπ Control de estado
let pendingId = null;
let scanningPaused = false;
let cameraReady = false;

// Abrir c√°mara
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
    video.srcObject = stream;
    video.play();

    video.onloadedmetadata = () => {
        cameraReady = true;
        console.log("üì∑ C√°mara lista:", video.videoWidth, video.videoHeight);
    };
})
.catch(err => {
    console.error(err);
    resultDiv.innerText = "No se pudo abrir la c√°mara";
});

// Capturar frame cada 2 segundos
setInterval(() => {
    captureAndSend();
}, 2000);

function captureAndSend() {
    if (scanningPaused) return;
    if (!cameraReady) return;
    if (!video.videoWidth || !video.videoHeight) return;

    const context = canvas.getContext('2d');

    // üî• CLAVE: usar tama√±o REAL del video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
        if (!blob) {
            console.warn("‚ùå Blob vac√≠o");
            return;
        }

        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');

        fetch('/employees/recognize-face/', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            console.log("RESPUESTA BACKEND:", data);

            if (data.error) {
                resultDiv.innerHTML = "Buscando rostro...";
                resultDiv.style.color = "#ffffff";
                return;
            }

            if (data.recognized === true) {

                // üõë Caso bloqueado (ya marc√≥ todo hoy)
                if (data.blocked === true) {
                    resultDiv.innerHTML =
                        "‚ö†Ô∏è <b>" + data.employee_name + "</b><br>" +
                        (data.message || "Asistencia ya completada");
                    resultDiv.style.color = "#ffc107";

                    setTimeout(() => {
                        scanningPaused = false;
                    }, 2000);

                    return;
                }

                // Caso normal (requiere confirmaci√≥n)
                resultDiv.innerHTML = "‚úÖ Bienvenido <br><b>" + data.employee_name + "</b>";
                resultDiv.style.color = "#00e676";

                showConfirmBox(
                    data.employee_name,
                    data.suggested_type,
                    data.pending_id
                );
                return;
            }

            resultDiv.innerHTML = "‚ùå " + (data.message || "Rostro no registrado");
            resultDiv.style.color = "#ff5252";
        })
        .catch(err => {
            console.error("ERROR FETCH:", err);
            resultDiv.innerText = "Error de conexi√≥n";
        });

    }, 'image/jpeg', 0.9);
}

// ================================
// üîπ FUNCIONES DE CONFIRMACI√ìN
// ================================

function showConfirmBox(name, type, pid) {
    pendingId = pid;
    scanningPaused = true;

    document.getElementById("confirmName").textContent = name;
    document.getElementById("confirmType").textContent =
        type === "in" ? "ENTRADA" : "SALIDA";

    document.getElementById("confirmBox").style.display = "block";
}

function hideConfirmBox() {
    pendingId = null;
    document.getElementById("confirmBox").style.display = "none";
}

async function confirmAttendance() {
    if (!pendingId) return;

    const res = await fetch("/employees/confirm-attendance/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pending_id: pendingId })
    });

    const data = await res.json();

    if (data.success) {
        let msg = "üïí <b>" + data.attendance_type.toUpperCase() + "</b>";

        if (data.status === "late") {
            msg += "<br>‚è∞ Atraso";
            if (data.delay_minutes !== null) {
                msg += " (" + data.delay_minutes + " min)";
            }
            resultDiv.style.color = "#ff9800";
        } else {
            msg += "<br>‚úÖ A tiempo";
            resultDiv.style.color = "#00c853";
        }

        resultDiv.innerHTML = msg;
    } else {
        resultDiv.innerHTML = "‚ùå Error al registrar asistencia";
        resultDiv.style.color = "#ff5252";
    }

    hideConfirmBox();

    setTimeout(() => {
        scanningPaused = false;
    }, 1200);
}

function cancelAttendance() {
    hideConfirmBox();
    scanningPaused = false;
}

document.getElementById("btnConfirm").addEventListener("click", confirmAttendance);
document.getElementById("btnCancel").addEventListener("click", cancelAttendance);
</script>

</body>
</html>
