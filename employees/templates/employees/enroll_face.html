<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Enrolar rostro</title>
<style>
  body { font-family: Arial; text-align: center; }
  video, canvas { border-radius: 12px; }
  button { padding: 12px 24px; font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>

<h1>Enrolar rostro: {{ employee.first_name }} {{ employee.last_name }}</h1>

<video id="video" width="400" height="300" autoplay></video>
<canvas id="canvas" width="400" height="300" style="display:none;"></canvas>

<br>
<button onclick="capture()">üì∏ Capturar</button>
<p id="msg"></p>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const msg = document.getElementById('msg');

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
    video.play();
  });

function capture() {
  if (!video.videoWidth || !video.videoHeight) {
    msg.innerText = '‚ùå C√°mara no lista';
    return;
  }

  // üî• CLAVE: sincronizar tama√±o real
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(blob => {
    if (!blob) {
      msg.innerText = '‚ùå Error capturando imagen';
      return;
    }

    const formData = new FormData();
    formData.append('image', blob, 'face.jpg');

    fetch('{% url "upload_face" employee.id %}', {
      method: 'POST',
      body: formData,
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        msg.innerText = '‚ùå ' + data.error;
      } else {
        msg.innerText = '‚úîÔ∏è Foto guardada';
      }
    })
    .catch(err => {
      console.error(err);
      msg.innerText = '‚ùå Error';
    });
  }, 'image/jpeg', 0.9);
}
</script>


</body>
</html>
